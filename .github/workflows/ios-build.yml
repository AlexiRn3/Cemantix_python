name: Build iOS App

on:
  workflow_dispatch:
  push:
    branches:
      - android 

jobs:
  build-ios:
    runs-on: macos-latest
    environment: Production

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- 1. Installation des dépendances ---
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' 
      
      - name: Install JavaScript Dependencies
        # CLÉ DE LA CORRECTION : Exécution du npm install dans le sous-dossier 'android'
        run: npm install
        working-directory: android 
        
      # --- 2. Préparation du projet iOS ---
      - name: Add iOS Platform
        # Ajout de la plateforme iOS depuis le bon dossier
        run: npx cap add ios || true 
        working-directory: android

      - name: Copy and Sync Web Assets
        # Exécution du script de synchronisation depuis le bon dossier
        run: npm run sync-ios
        working-directory: android
        
        # --- 3. Configuration et Compilation native (Nécessite Fastlane) ---
      - name: Build and Deploy to TestFlight (Example)
        # Cette étape nécessite une configuration Fastlane (ou un script Xcode)
        env:
          FASTLANE_USER: ${{ secrets.APPLE_ID }}
          FASTLANE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          FASTLANE_TEAM_ID: ${{ secrets.FASTLANE_TEAM_ID }}
          # Assurez-vous que Fastlane est configuré pour trouver et signer votre projet Xcode
        run: |
          echo "Placeholder: Exécutez ici votre commande Fastlane de compilation."

      # --- 4. Artefacts (Récupération du fichier IPA) ---
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        if: always() # Continue même si la compilation échoue (pour voir les logs)
        with:
          name: ios-build-artifact
          # Le chemin exact vers le fichier .ipa généré par Fastlane
          path: ./ios/build/Release-iphoneos/VotreApp.ipa