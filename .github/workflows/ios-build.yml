name: Build iOS App

on:
  # Permet de lancer le workflow manuellement depuis l'interface GitHub
  workflow_dispatch:
  # Déclenche le workflow à chaque push sur la branche 'android'
  push:
    branches:
      - android 

jobs:
  build-ios:
    # Utilise la machine virtuelle macOS
    runs-on: macos-latest
    environment: Production

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        # Utilise la branche 'android'

      # --- 1. Installation des dépendances ---
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' 
      
      - name: Install JavaScript Dependencies
        run: npm install

      # --- 2. Préparation du projet iOS ---
      - name: Add iOS Platform
        run: npx cap add ios || true 
        # Ajoute la plateforme si elle n'existe pas, ou continue si elle existe.

      - name: Copy and Sync Web Assets
        # CLÉ DE LA CORRECTION: Utilise le chemin direct au binaire Capacitor
        run: npx cap sync ios

      # --- 3. Configuration et Compilation native (Nécessite Fastlane) ---
      - name: Build and Deploy to TestFlight (Example)
        # Cette étape nécessite une configuration Fastlane (ou un script Xcode)
        env:
          FASTLANE_USER: ${{ secrets.APPLE_ID }}
          FASTLANE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          FASTLANE_TEAM_ID: ${{ secrets.FASTLANE_TEAM_ID }}
          # Assurez-vous que Fastlane est configuré pour trouver et signer votre projet Xcode
        run: |
          echo "Placeholder: Exécutez ici votre commande Fastlane de compilation."
          # Exemple de commande Fastlane (à décommenter et configurer) :
          # fastlane build_and_deploy

      # --- 4. Artefacts (Récupération du fichier IPA) ---
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        # Ne s'exécute que si les étapes précédentes sont passées (success() est par défaut)
        with:
          name: ios-build-artifact
          # ATTENTION : Ce chemin est un exemple. Vous devez le remplacer par le chemin
          # exact où Fastlane ou Xcode place le fichier .ipa généré.
          path: ./ios/build/Release-iphoneos/VotreApp.ipa 
          # Remplacez 'VotreApp.ipa' par le nom réel du paquet !