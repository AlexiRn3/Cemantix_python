name: Build iOS App

on:
  # Permet de lancer le workflow manuellement depuis l'interface GitHub
  workflow_dispatch:
  # Déclenche le workflow à chaque push sur la branche 'android'
  push:
    branches:
      - android 

jobs:
  build-ios:
    # Utilise la machine virtuelle macOS
    runs-on: macos-latest
    environment: Production

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        # Utilise la branche 'android'

      # --- 1. Installation des dépendances ---
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' 
      
      - name: Install JavaScript Dependencies
        # Cette étape installe le script 'sync-ios'
        run: npm install

      # --- 2. Préparation du projet iOS ---
      - name: Add iOS Platform
        # Utiliser npx ici est souvent OK pour l'ajout initial
        run: npx cap add ios || true 

      - name: Copy and Sync Web Assets
        # NOUVELLE MÉTHODE FIABLE: Exécute le script 'sync-ios'
        run: npm run sync-ios

      # --- 3. Configuration et Compilation native (Nécessite Fastlane) ---
      - name: Build and Deploy to TestFlight (Example)
        # Cette étape nécessite une configuration Fastlane (ou un script Xcode)
        env:
          FASTLANE_USER: ${{ secrets.APPLE_ID }}
          FASTLANE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          FASTLANE_TEAM_ID: ${{ secrets.FASTLANE_TEAM_ID }}
          # Assurez-vous que Fastlane est configuré pour trouver et signer votre projet Xcode
        run: |
          echo "Placeholder: Exécutez ici votre commande Fastlane de compilation."

      # --- 4. Artefacts (Récupération du fichier IPA) ---
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        if: always() # Continue même si la compilation échoue (pour voir les logs)
        with:
          name: ios-build-artifact
          # Le chemin exact vers le fichier .ipa généré par Fastlane
          path: ./ios/build/Release-iphoneos/VotreApp.ipa