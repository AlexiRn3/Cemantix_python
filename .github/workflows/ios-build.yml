name: Build iOS App

on:
  # Déclenche le workflow manuellement
  workflow_dispatch:
  # Déclenche le workflow à chaque push sur la branche 'android'
  push:
    branches:
      - android 

jobs:
  build-ios:
    # CLÉ: Utilise la machine virtuelle macOS
    runs-on: macos-latest
    environment: Production

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        # Utilise la branche 'android' qui contient les dossiers natifs

      # --- 1. Installation des dépendances ---
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Assurez-vous d'utiliser une version compatible avec Capacitor

      - name: Install JavaScript Dependencies
        run: npm install

      # --- 2. Installation de Fastlane et Ruby ---
      - name: Setup Ruby and Install Fastlane
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3' 
          bundler-cache: true 

      - name: Install Fastlane
        run: gem install fastlane

      # --- 3. Synchronisation et Préparation iOS ---
      - name: Add and Sync iOS (if missing)
        run: npx cap add ios || true 
        # Le || true permet de ne pas échouer si iOS est déjà ajouté
      - name: Copy Web Assets and Plugins
        run: npx cap sync ios

      # --- 4. Compilation et Signature de l'application ---
      # Il est recommandé d'utiliser un outil comme Fastlane pour la compilation et la signature.
      # Ce script suppose que vous avez Fastlane configuré.
      - name: Build and Deploy to TestFlight (Example)
        env:
          # Passage des secrets à l'environnement Fastlane
          FASTLANE_USER: ${{ secrets.APPLE_ID }}
          FASTLANE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          FASTLANE_TEAM_ID: ${{ secrets.FASTLANE_TEAM_ID }}
        run: |
          # Fastlane prend le relai pour compiler le projet Xcode et le signer
          # fastlane pilot upload --ipa ./path/to/YourApp.ipa
          echo "Fastlane configuration is required here for signing and deployment."

      # --- 5. Artefacts (optionnel) ---
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ios-build-artifact
          path: # Chemin vers le fichier .ipa généré par Fastlane